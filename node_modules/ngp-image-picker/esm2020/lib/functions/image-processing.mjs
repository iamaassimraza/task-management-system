export const MAX_BUFFER_UNDO_MEMORY = 25;
let rotate = 1;
export const convertImageUsingCanvas = (datas, changeHeight = false, state, options) => {
    return new Promise(async (resolve, _) => {
        let img = document.createElement('img');
        img.src = datas + '';
        img.crossOrigin = 'Anonymous';
        let quality = state.quality / 100;
        let maintainRatio = state.maintainAspectRatio;
        img.onload = () => {
            var canvas = document.createElement('canvas');
            let ctx = canvas.getContext('2d');
            if (!ctx)
                return;
            let ratio = img.width / img.height;
            let width = state.maxWidth;
            let height = state.maxHeight;
            if (options?.getDimFromImage) {
                width = img.width;
                height = img.height;
            }
            if (maintainRatio) {
                canvas.width = width;
                canvas.height = width / ratio;
                if (changeHeight) {
                    canvas.width = height * ratio;
                    canvas.height = height;
                }
            }
            else {
                canvas.width = width;
                canvas.height = height;
            }
            if (state.basicFilters) {
                ctx.filter = processFilter(state.basicFilters);
            }
            // if (options?.rotate) {
            //   canvas.width = height;
            //   canvas.height = width;
            //   if (options?.rotate === 90) {
            //     ctx.rotate((90 * Math.PI) / 180);
            //     ctx.translate(0, -canvas.width);
            //   } else {
            //     ctx.rotate((-90 * Math.PI) / 180);
            //     ctx.translate(-canvas.height, 0);
            //   }
            //   ctx.drawImage(img, 0, 0);
            // } else {
            // }
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            let type = state.format;
            var dataURI = canvas.toDataURL(`image/${type}`, quality);
            resolve({
                dataUri: dataURI,
                width: canvas.width,
                height: canvas.height,
            });
        };
    }).then((data) => {
        state.maxHeight = data.height;
        state.maxWidth = data.width;
        saveState(state, data.dataUri);
        return data.dataUri;
    });
    function processFilter(data) {
        return Object.keys(data)
            .map((key) => {
            if (['blur'].includes(key)) {
                return `${key}(${data[key]}px)`;
            }
            else {
                return `${key}(${data[key]})`;
            }
        })
            .join('');
    }
};
export const dragElement = (elemnt) => {
    if (!elemnt)
        return;
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    if (document.getElementById(elemnt.id + '-header')) {
        /* if present, the header is where you move the DIV from:*/
        let elementRef = document.getElementById(elemnt?.id + '-header');
        if (!elementRef)
            return;
        elementRef.onmousedown = dragPressOn;
        elementRef.ontouchstart = dragPressOn;
    }
    else {
        /* otherwise, move the DIV from anywhere inside the DIV:*/
        elemnt.ontouchstart = dragPressOn;
        elemnt.onmousedown = dragPressOn;
    }
    function dragPressOn(e) {
        let popup = document.querySelector('#popup');
        popup.style.overflowY = 'hidden';
        e = e || window.event;
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.ontouchend = closeDragElement;
        document.onmouseup = closeDragElement;
        document.ontouchmove = elementDragTouch;
        document.onmousemove = elementDragMouse;
    }
    function elementDragMouse(e) {
        let holderImage = document.getElementById('image-full');
        e = e || window.event;
        pos1 = pos3 - e.clientX;
        pos3 = e.clientX;
        pos2 = pos4 - e.clientY;
        pos4 = e.clientY;
        let newTop = elemnt.offsetTop - pos2;
        let newLeft = elemnt.offsetLeft - pos1;
        let rectHolder = holderImage?.getBoundingClientRect();
        let rectElemnt = elemnt.getBoundingClientRect();
        // console.log('====================================');
        // console.log(rectElemnt,rectHolder);
        // console.log('====================================');
        newTop = Math.max(newTop, rectHolder?.top);
        newTop = Math.min(newTop, rectHolder?.bottom - rectElemnt.height);
        newLeft = Math.max(newLeft, rectHolder?.left);
        newLeft = Math.min(newLeft, rectHolder?.right - rectElemnt.width);
        elemnt.style.top = newTop + 'px';
        elemnt.style.left = newLeft + 'px';
    }
    function elementDragTouch(e) {
        let holderImage = document.getElementById('image-full');
        e = e || window.event;
        if (e?.changedTouches?.length) {
            pos1 = pos3 - e.changedTouches[0]?.clientX;
            pos3 = e.changedTouches[0]?.clientX;
        }
        if (e?.changedTouches?.length) {
            pos2 = pos4 - e.changedTouches[0]?.clientY;
            pos4 = e.changedTouches[0]?.clientY;
        }
        let newTop = elemnt.offsetTop - pos2;
        let newLeft = elemnt.offsetLeft - pos1;
        let rectHolder = holderImage?.getBoundingClientRect();
        let rectElemnt = elemnt.getBoundingClientRect();
        // console.log('====================================');
        // console.log(rectElemnt,rectHolder);
        // console.log('====================================');
        newTop = Math.max(newTop, rectHolder?.top);
        newTop = Math.min(newTop, rectHolder?.bottom - rectElemnt.height);
        newLeft = Math.max(newLeft, rectHolder?.left);
        newLeft = Math.min(newLeft, rectHolder?.right - rectElemnt.width);
        elemnt.style.top = newTop + 'px';
        elemnt.style.left = newLeft + 'px';
    }
    function closeDragElement() {
        /* stop moving when mouse button is released:*/
        let popup = document.querySelector('#popup');
        popup.style.overflowY = 'auto';
        document.onmouseup = null;
        document.onmousemove = null;
        document.ontouchend = null;
        document.ontouchmove = null;
    }
};
export const saveState = (state, lastImage) => {
    if (state.arrayCopiedImages.length <= MAX_BUFFER_UNDO_MEMORY) {
        state.arrayCopiedImages.push({
            lastImage: lastImage,
            width: state.maxWidth,
            height: state.maxHeight,
            quality: state.quality,
            format: state.format,
            originImageSrc: state.originImageSrc,
            basicFilters: state.basicFilters,
        });
    }
    else {
        state.arrayCopiedImages[state.arrayCopiedImages.length - 1] = {
            lastImage: lastImage,
            width: state.maxWidth,
            height: state.maxHeight,
            quality: state.quality,
            format: state.format,
            originImageSrc: state.originImageSrc,
            basicFilters: state.basicFilters,
        };
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtcHJvY2Vzc2luZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25ncC1pbWFnZS1waWNrZXIvc3JjL2xpYi9mdW5jdGlvbnMvaW1hZ2UtcHJvY2Vzc2luZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxNQUFNLENBQUMsTUFBTSxzQkFBc0IsR0FBRyxFQUFFLENBQUM7QUFDekMsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBRWYsTUFBTSxDQUFDLE1BQU0sdUJBQXVCLEdBQUcsQ0FDckMsS0FBVSxFQUNWLFlBQVksR0FBRyxLQUFLLEVBQ3BCLEtBQWEsRUFDYixPQUF3RCxFQUN2QyxFQUFFO0lBQ25CLE9BQU8sSUFBSSxPQUFPLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUN0QyxJQUFJLEdBQUcsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3hDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNyQixHQUFHLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUM5QixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztRQUNsQyxJQUFJLGFBQWEsR0FBRyxLQUFLLENBQUMsbUJBQW1CLENBQUM7UUFFOUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDaEIsSUFBSSxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM5QyxJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xDLElBQUksQ0FBQyxHQUFHO2dCQUFFLE9BQU87WUFDakIsSUFBSSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1lBQ25DLElBQUksS0FBSyxHQUFHLEtB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Y0FBd0I7WUFDOUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxZQUFZO1NBQ2pDLENBQUMsQ0FBQztLQUNKO1NBQU07UUFDTCxLQUFLLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsR0FBRztZQUM1RCxTQUFTLEVBQUUsU0FBbUI7WUFDOUIsS0FBSyxFQUFFLEtBQUssQ0FBQyxRQUFRO1lBQ3JCLE1BQU0sRUFBRSxLQUFLLENBQUMsU0FBUztZQUN2QixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87WUFDdEIsTUFBTSxFQUFFLEtBQUssQ0FBQyxNQUFNO1lBQ3BCLGNBQWMsRUFBRSxLQUFLLENBQUMsY0FBd0I7WUFDOUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxZQUFZO1NBQ2pDLENBQUM7S0FDSDtBQUNILENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElTdGF0ZSB9IGZyb20gJy4uL21vZGVscy9pbmRleC5tb2RlbHMnO1xuXG5leHBvcnQgY29uc3QgTUFYX0JVRkZFUl9VTkRPX01FTU9SWSA9IDI1O1xubGV0IHJvdGF0ZSA9IDE7XG5cbmV4cG9ydCBjb25zdCBjb252ZXJ0SW1hZ2VVc2luZ0NhbnZhcyA9IChcbiAgZGF0YXM6IGFueSxcbiAgY2hhbmdlSGVpZ2h0ID0gZmFsc2UsXG4gIHN0YXRlOiBJU3RhdGUsXG4gIG9wdGlvbnM/OiB7IGdldERpbUZyb21JbWFnZT86IGJvb2xlYW47IHJvdGF0ZT86IG51bWJlciB9LFxuKTogUHJvbWlzZTxzdHJpbmc+ID0+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCBfKSA9PiB7XG4gICAgbGV0IGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xuICAgIGltZy5zcmMgPSBkYXRhcyArICcnO1xuICAgIGltZy5jcm9zc09yaWdpbiA9ICdBbm9ueW1vdXMnO1xuICAgIGxldCBxdWFsaXR5ID0gc3RhdGUucXVhbGl0eSAvIDEwMDtcbiAgICBsZXQgbWFpbnRhaW5SYXRpbyA9IHN0YXRlLm1haW50YWluQXNwZWN0UmF0aW87XG5cbiAgICBpbWcub25sb2FkID0gKCkgPT4ge1xuICAgICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgbGV0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICAgICAgaWYgKCFjdHgpIHJldHVybjtcbiAgICAgIGxldCByYXRpbyA9IGltZy53aWR0aCAvIGltZy5oZWlnaHQ7XG4gICAgICBsZXQgd2lkdGggPSBzdGF0ZS5tYXhXaWR0aDtcbiAgICAgIGxldCBoZWlnaHQgPSBzdGF0ZS5tYXhIZWlnaHQ7XG5cbiAgICAgIGlmIChvcHRpb25zPy5nZXREaW1Gcm9tSW1hZ2UpIHtcbiAgICAgICAgd2lkdGggPSBpbWcud2lkdGg7XG4gICAgICAgIGhlaWdodCA9IGltZy5oZWlnaHQ7XG4gICAgICB9XG5cbiAgICAgIGlmIChtYWludGFpblJhdGlvKSB7XG4gICAgICAgIGNhbnZhcy53aWR0aCA9IHdpZHRoO1xuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gd2lkdGggLyByYXRpbztcbiAgICAgICAgaWYgKGNoYW5nZUhlaWdodCkge1xuICAgICAgICAgIGNhbnZhcy53aWR0aCA9IGhlaWdodCAqIHJhdGlvO1xuICAgICAgICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbnZhcy53aWR0aCA9IHdpZHRoO1xuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgfVxuICAgICAgaWYgKHN0YXRlLmJhc2ljRmlsdGVycykge1xuICAgICAgICBjdHguZmlsdGVyID0gcHJvY2Vzc0ZpbHRlcihzdGF0ZS5iYXNpY0ZpbHRlcnMpO1xuICAgICAgfVxuICAgICAgLy8gaWYgKG9wdGlvbnM/LnJvdGF0ZSkge1xuICAgICAgLy8gICBjYW52YXMud2lkdGggPSBoZWlnaHQ7XG4gICAgICAvLyAgIGNhbnZhcy5oZWlnaHQgPSB3aWR0aDtcbiAgICAgIC8vICAgaWYgKG9wdGlvbnM/LnJvdGF0ZSA9PT0gOTApIHtcbiAgICAgIC8vICAgICBjdHgucm90YXRlKCg5MCAqIE1hdGguUEkpIC8gMTgwKTtcbiAgICAgIC8vICAgICBjdHgudHJhbnNsYXRlKDAsIC1jYW52YXMud2lkdGgpO1xuICAgICAgLy8gICB9IGVsc2Uge1xuICAgICAgLy8gICAgIGN0eC5yb3RhdGUoKC05MCAqIE1hdGguUEkpIC8gMTgwKTtcbiAgICAgIC8vICAgICBjdHgudHJhbnNsYXRlKC1jYW52YXMuaGVpZ2h0LCAwKTtcbiAgICAgIC8vICAgfVxuICAgICAgLy8gICBjdHguZHJhd0ltYWdlKGltZywgMCwgMCk7XG4gICAgICAvLyB9IGVsc2Uge1xuICAgICAgLy8gfVxuICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG4gICAgICBsZXQgdHlwZSA9IHN0YXRlLmZvcm1hdDtcbiAgICAgIHZhciBkYXRhVVJJID0gY2FudmFzLnRvRGF0YVVSTChgaW1hZ2UvJHt0eXBlfWAsIHF1YWxpdHkpO1xuICAgICAgcmVzb2x2ZSh7XG4gICAgICAgIGRhdGFVcmk6IGRhdGFVUkksXG4gICAgICAgIHdpZHRoOiBjYW52YXMud2lkdGgsXG4gICAgICAgIGhlaWdodDogY2FudmFzLmhlaWdodCxcbiAgICAgIH0pO1xuICAgIH07XG4gIH0pLnRoZW4oKGRhdGE6IGFueSkgPT4ge1xuICAgIHN0YXRlLm1heEhlaWdodCA9IGRhdGEuaGVpZ2h0O1xuICAgIHN0YXRlLm1heFdpZHRoID0gZGF0YS53aWR0aDtcbiAgICBzYXZlU3RhdGUoc3RhdGUsIGRhdGEuZGF0YVVyaSk7XG4gICAgcmV0dXJuIGRhdGEuZGF0YVVyaTtcbiAgfSk7XG5cbiAgZnVuY3Rpb24gcHJvY2Vzc0ZpbHRlcihkYXRhOiBhbnkpIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXMoZGF0YSlcbiAgICAgIC5tYXAoKGtleSkgPT4ge1xuICAgICAgICBpZiAoWydibHVyJ10uaW5jbHVkZXMoa2V5KSkge1xuICAgICAgICAgIHJldHVybiBgJHtrZXl9KCR7ZGF0YVtrZXldfXB4KWA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIGAke2tleX0oJHtkYXRhW2tleV19KWA7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuam9pbignJyk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBkcmFnRWxlbWVudCA9IChlbGVtbnQ6IGFueSkgPT4ge1xuICBpZiAoIWVsZW1udCkgcmV0dXJuO1xuICBsZXQgcG9zMSA9IDAsXG4gICAgcG9zMiA9IDAsXG4gICAgcG9zMyA9IDAsXG4gICAgcG9zNCA9IDA7XG4gIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbGVtbnQuaWQgKyAnLWhlYWRlcicpKSB7XG4gICAgLyogaWYgcHJlc2VudCwgdGhlIGhlYWRlciBpcyB3aGVyZSB5b3UgbW92ZSB0aGUgRElWIGZyb206Ki9cbiAgICBsZXQgZWxlbWVudFJlZiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKChlbGVtbnQ/LmlkIGFzIGFueSkgKyAnLWhlYWRlcicpO1xuICAgIGlmICghZWxlbWVudFJlZikgcmV0dXJuO1xuICAgIGVsZW1lbnRSZWYub25tb3VzZWRvd24gPSBkcmFnUHJlc3NPbjtcbiAgICBlbGVtZW50UmVmLm9udG91Y2hzdGFydCA9IGRyYWdQcmVzc09uO1xuICB9IGVsc2Uge1xuICAgIC8qIG90aGVyd2lzZSwgbW92ZSB0aGUgRElWIGZyb20gYW55d2hlcmUgaW5zaWRlIHRoZSBESVY6Ki9cbiAgICBlbGVtbnQub250b3VjaHN0YXJ0ID0gZHJhZ1ByZXNzT247XG4gICAgZWxlbW50Lm9ubW91c2Vkb3duID0gZHJhZ1ByZXNzT247XG4gIH1cblxuICBmdW5jdGlvbiBkcmFnUHJlc3NPbihlOiBhbnkpIHtcbiAgICBsZXQgcG9wdXA6IGFueSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwb3B1cCcpO1xuICAgIHBvcHVwLnN0eWxlLm92ZXJmbG93WSA9ICdoaWRkZW4nO1xuICAgIGUgPSBlIHx8IHdpbmRvdy5ldmVudDtcbiAgICBwb3MzID0gZS5jbGllbnRYO1xuICAgIHBvczQgPSBlLmNsaWVudFk7XG4gICAgZG9jdW1lbnQub250b3VjaGVuZCA9IGNsb3NlRHJhZ0VsZW1lbnQ7XG4gICAgZG9jdW1lbnQub25tb3VzZXVwID0gY2xvc2VEcmFnRWxlbWVudDtcbiAgICBkb2N1bWVudC5vbnRvdWNobW92ZSA9IGVsZW1lbnREcmFnVG91Y2g7XG4gICAgZG9jdW1lbnQub25tb3VzZW1vdmUgPSBlbGVtZW50RHJhZ01vdXNlO1xuICB9XG5cbiAgZnVuY3Rpb24gZWxlbWVudERyYWdNb3VzZShlOiBhbnkpIHtcbiAgICBsZXQgaG9sZGVySW1hZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW1hZ2UtZnVsbCcpO1xuICAgIGUgPSBlIHx8IHdpbmRvdy5ldmVudDtcbiAgICBwb3MxID0gcG9zMyAtIGUuY2xpZW50WDtcbiAgICBwb3MzID0gZS5jbGllbnRYO1xuICAgIHBvczIgPSBwb3M0IC0gZS5jbGllbnRZO1xuICAgIHBvczQgPSBlLmNsaWVudFk7XG5cbiAgICBsZXQgbmV3VG9wID0gZWxlbW50Lm9mZnNldFRvcCAtIHBvczI7XG4gICAgbGV0IG5ld0xlZnQgPSBlbGVtbnQub2Zmc2V0TGVmdCAtIHBvczE7XG4gICAgbGV0IHJlY3RIb2xkZXIgPSBob2xkZXJJbWFnZT8uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgbGV0IHJlY3RFbGVtbnQgPSBlbGVtbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgLy8gY29uc29sZS5sb2coJz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PScpO1xuICAgIC8vIGNvbnNvbGUubG9nKHJlY3RFbGVtbnQscmVjdEhvbGRlcik7XG4gICAgLy8gY29uc29sZS5sb2coJz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PScpO1xuICAgIG5ld1RvcCA9IE1hdGgubWF4KG5ld1RvcCwgcmVjdEhvbGRlcj8udG9wIGFzIG51bWJlcik7XG4gICAgbmV3VG9wID0gTWF0aC5taW4obmV3VG9wLCAocmVjdEhvbGRlcj8uYm90dG9tIGFzIG51bWJlcikgLSByZWN0RWxlbW50LmhlaWdodCk7XG4gICAgbmV3TGVmdCA9IE1hdGgubWF4KG5ld0xlZnQsIHJlY3RIb2xkZXI/LmxlZnQgYXMgbnVtYmVyKTtcbiAgICBuZXdMZWZ0ID0gTWF0aC5taW4obmV3TGVmdCwgKHJlY3RIb2xkZXI/LnJpZ2h0IGFzIG51bWJlcikgLSByZWN0RWxlbW50LndpZHRoKTtcbiAgICBlbGVtbnQuc3R5bGUudG9wID0gbmV3VG9wICsgJ3B4JztcbiAgICBlbGVtbnQuc3R5bGUubGVmdCA9IG5ld0xlZnQgKyAncHgnO1xuICB9XG5cbiAgZnVuY3Rpb24gZWxlbWVudERyYWdUb3VjaChlOiBhbnkpIHtcbiAgICBsZXQgaG9sZGVySW1hZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW1hZ2UtZnVsbCcpO1xuICAgIGUgPSBlIHx8IHdpbmRvdy5ldmVudDtcblxuICAgIGlmIChlPy5jaGFuZ2VkVG91Y2hlcz8ubGVuZ3RoKSB7XG4gICAgICBwb3MxID0gcG9zMyAtIGUuY2hhbmdlZFRvdWNoZXNbMF0/LmNsaWVudFg7XG4gICAgICBwb3MzID0gZS5jaGFuZ2VkVG91Y2hlc1swXT8uY2xpZW50WDtcbiAgICB9XG4gICAgaWYgKGU/LmNoYW5nZWRUb3VjaGVzPy5sZW5ndGgpIHtcbiAgICAgIHBvczIgPSBwb3M0IC0gZS5jaGFuZ2VkVG91Y2hlc1swXT8uY2xpZW50WTtcbiAgICAgIHBvczQgPSBlLmNoYW5nZWRUb3VjaGVzWzBdPy5jbGllbnRZO1xuICAgIH1cblxuICAgIGxldCBuZXdUb3AgPSBlbGVtbnQub2Zmc2V0VG9wIC0gcG9zMjtcbiAgICBsZXQgbmV3TGVmdCA9IGVsZW1udC5vZmZzZXRMZWZ0IC0gcG9zMTtcbiAgICBsZXQgcmVjdEhvbGRlciA9IGhvbGRlckltYWdlPy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBsZXQgcmVjdEVsZW1udCA9IGVsZW1udC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgIC8vIGNvbnNvbGUubG9nKCc9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0nKTtcbiAgICAvLyBjb25zb2xlLmxvZyhyZWN0RWxlbW50LHJlY3RIb2xkZXIpO1xuICAgIC8vIGNvbnNvbGUubG9nKCc9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0nKTtcblxuICAgIG5ld1RvcCA9IE1hdGgubWF4KG5ld1RvcCwgcmVjdEhvbGRlcj8udG9wIGFzIG51bWJlcik7XG4gICAgbmV3VG9wID0gTWF0aC5taW4obmV3VG9wLCAocmVjdEhvbGRlcj8uYm90dG9tIGFzIG51bWJlcikgLSByZWN0RWxlbW50LmhlaWdodCk7XG4gICAgbmV3TGVmdCA9IE1hdGgubWF4KG5ld0xlZnQsIHJlY3RIb2xkZXI/LmxlZnQgYXMgbnVtYmVyKTtcbiAgICBuZXdMZWZ0ID0gTWF0aC5taW4obmV3TGVmdCwgKHJlY3RIb2xkZXI/LnJpZ2h0IGFzIG51bWJlcikgLSByZWN0RWxlbW50LndpZHRoKTtcbiAgICBlbGVtbnQuc3R5bGUudG9wID0gbmV3VG9wICsgJ3B4JztcbiAgICBlbGVtbnQuc3R5bGUubGVmdCA9IG5ld0xlZnQgKyAncHgnO1xuICB9XG5cbiAgZnVuY3Rpb24gY2xvc2VEcmFnRWxlbWVudCgpIHtcbiAgICAvKiBzdG9wIG1vdmluZyB3aGVuIG1vdXNlIGJ1dHRvbiBpcyByZWxlYXNlZDoqL1xuICAgIGxldCBwb3B1cDogYW55ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3BvcHVwJyk7XG4gICAgcG9wdXAuc3R5bGUub3ZlcmZsb3dZID0gJ2F1dG8nO1xuICAgIGRvY3VtZW50Lm9ubW91c2V1cCA9IG51bGw7XG4gICAgZG9jdW1lbnQub25tb3VzZW1vdmUgPSBudWxsO1xuICAgIGRvY3VtZW50Lm9udG91Y2hlbmQgPSBudWxsO1xuICAgIGRvY3VtZW50Lm9udG91Y2htb3ZlID0gbnVsbDtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHNhdmVTdGF0ZSA9IChzdGF0ZTogSVN0YXRlLCBsYXN0SW1hZ2U/OiBzdHJpbmcpID0+IHtcbiAgaWYgKHN0YXRlLmFycmF5Q29waWVkSW1hZ2VzLmxlbmd0aCA8PSBNQVhfQlVGRkVSX1VORE9fTUVNT1JZKSB7XG4gICAgc3RhdGUuYXJyYXlDb3BpZWRJbWFnZXMucHVzaCh7XG4gICAgICBsYXN0SW1hZ2U6IGxhc3RJbWFnZSBhcyBzdHJpbmcsXG4gICAgICB3aWR0aDogc3RhdGUubWF4V2lkdGgsXG4gICAgICBoZWlnaHQ6IHN0YXRlLm1heEhlaWdodCxcbiAgICAgIHF1YWxpdHk6IHN0YXRlLnF1YWxpdHksXG4gICAgICBmb3JtYXQ6IHN0YXRlLmZvcm1hdCxcbiAgICAgIG9yaWdpbkltYWdlU3JjOiBzdGF0ZS5vcmlnaW5JbWFnZVNyYyBhcyBzdHJpbmcsXG4gICAgICBiYXNpY0ZpbHRlcnM6IHN0YXRlLmJhc2ljRmlsdGVycyxcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBzdGF0ZS5hcnJheUNvcGllZEltYWdlc1tzdGF0ZS5hcnJheUNvcGllZEltYWdlcy5sZW5ndGggLSAxXSA9IHtcbiAgICAgIGxhc3RJbWFnZTogbGFzdEltYWdlIGFzIHN0cmluZyxcbiAgICAgIHdpZHRoOiBzdGF0ZS5tYXhXaWR0aCxcbiAgICAgIGhlaWdodDogc3RhdGUubWF4SGVpZ2h0LFxuICAgICAgcXVhbGl0eTogc3RhdGUucXVhbGl0eSxcbiAgICAgIGZvcm1hdDogc3RhdGUuZm9ybWF0LFxuICAgICAgb3JpZ2luSW1hZ2VTcmM6IHN0YXRlLm9yaWdpbkltYWdlU3JjIGFzIHN0cmluZyxcbiAgICAgIGJhc2ljRmlsdGVyczogc3RhdGUuYmFzaWNGaWx0ZXJzLFxuICAgIH07XG4gIH1cbn07XG4iXX0=